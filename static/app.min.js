document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("chat-container"),t=document.getElementById("user-input"),s=document.getElementById("send-button");function n(t,s,n=null){const a=document.createElement("div");a.className="p-4 rounded-lg "+("user"===t?"bg-blue-100":"assistant"===t?"bg-gray-100":"error"===t?"bg-red-100":"bg-yellow-100");const o=document.createElement("div");if(o.className="text-gray-800",o.innerHTML="user"===t?`<span class="font-bold">You:</span> ${s}`:"assistant"===t?`<span class="font-bold">Assistant:</span> ${s}`:"error"===t?`<span class="font-bold text-red-600">Error:</span> ${s}`:`<span class="font-bold text-yellow-600">System:</span> ${s}`,a.appendChild(o),n){const e=document.createElement("div");e.className="mt-2 text-sm text-gray-600 italic",e.textContent=`Sources: ${n}`,a.appendChild(e)}return e.appendChild(a),e.scrollTop=e.scrollHeight,a}function a(){const a=t.value.trim();if(!a)return;t.disabled=!0,s.disabled=!0,s.classList.add("opacity-50"),n("user",a),t.value="";const r=document.createElement("div");r.className="p-4 rounded-lg bg-gray-100";const c=document.createElement("div");c.className="text-gray-800",c.innerHTML='\n            <div class="flex items-center space-x-2">\n                <span class="font-bold">Assistant:</span>\n                <div class="typing-dots">\n                    <span></span>\n                    <span></span>\n                    <span></span>\n                </div>\n            </div>\n        ',r.appendChild(c),e.appendChild(r),e.scrollTop=e.scrollHeight;const l=encodeURIComponent(a),d=new EventSource(`/api/chat-stream?message=${l}`);d.onmessage=t=>{const s=t.data;if("[DONE]"===s)return d.close(),void o();if(s.startsWith("SOURCES:")){const e=s.substring(8);let t=r.querySelector(".sources");return t||(t=document.createElement("div"),t.className="mt-2 text-sm text-gray-600 italic sources",r.appendChild(t)),void(t.textContent=`Sources: ${e}`)}const n=c.querySelector(".typing-dots")?.parentElement;if(n?c.innerHTML=`<span class="font-bold">Assistant:</span> ${s}`:c.innerHTML+=s,sourceText){let e=r.querySelector(".sources");e||(e=document.createElement("div"),e.className="mt-2 text-sm text-gray-600 italic sources",r.appendChild(e)),e.textContent=`Sources: ${sourceText}`}e.scrollTop=e.scrollHeight},d.onerror=e=>{console.error("EventSource error:",e),c.querySelector(".typing-dots")&&(c.innerHTML='<span class="font-bold">Assistant:</span> <span class="text-red-600">Connection error. Please try again.</span>'),d.close(),o()}}function o(){t.disabled=!1,s.disabled=!1,s.classList.remove("opacity-50"),t.focus()}fetch("/status").then((e=>e.json())).then((e=>{"ready"!==e.status&&n("system",e.message)})).catch((e=>{n("error","Failed to connect to server")})),s.addEventListener("click",a),t.addEventListener("keypress",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),a())}))}));